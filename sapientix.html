<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAPIENTIX!</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* === Base Styles === */
      :root {
        --primary-color: #060d5d;
        --secondary-color: #0a1baa;
        --highlight-color: #2436ff;
        --text-color: #ffffff;
        --card-color: #0c1685;
        --hover-color: #2e3cff;
        --correct-color: #28a745;
        --wrong-color: #dc3545;
        --neutral-color: #6c757d;
        --board-grid-gap: 6px;
        /* Colori Oro per Start Button e Classifica */
        --gold-start: #ffd700;
        --gold-end: #e4a000;
        --gold-hover-start: #ffe033;
        --gold-hover-end: #f7b000;
        --gold-shadow: rgba(255, 215, 0, 0.5);
        --gold-text: #331a00; /* Testo scuro */
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Roboto", sans-serif;
        background-color: var(--primary-color);
        color: var(--text-color);
        height: 100vh;
        overflow: hidden;
      }
      .game-container {
        height: 100vh;
        width: 100vw;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      h1 {
        /* Stile H1 generale */
        text-align: center;
        font-size: 3rem;
        margin-bottom: 2rem;
        letter-spacing: 2px;
        text-transform: uppercase;
        text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
      }
      .hidden {
        display: none !important;
      }
      .active {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
      }
      #intro-screen.active {
        /* Usa .active */
      }
      button,
      .button-link,
      .button-like {
        /* Applica stile base */
        cursor: pointer;
        border: none;
        outline: none;
        border-radius: 5px;
        font-weight: bold;
        transition: transform 0.2s ease, background-color 0.2s ease,
          box-shadow 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.8rem 1.5rem;
      }
      button:active,
      .button-link:active,
      .button-like:active {
        transform: scale(0.98);
      }

      /* === Intro Screen === */
      #intro-screen {
        background-color: var(--primary-color);
        background-image: radial-gradient(
          circle at center,
          var(--secondary-color) 0%,
          var(--primary-color) 85%
        );
        overflow-y: auto;
        height: 100vh;
        width: 100vw;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #intro-screen::-webkit-scrollbar {
        width: 10px;
      }
      #intro-screen::-webkit-scrollbar-track {
        background: rgba(0, 0, 30, 0.5);
        border-radius: 5px;
      }
      #intro-screen::-webkit-scrollbar-thumb {
        background: var(--highlight-color);
        border-radius: 5px;
      }
      #intro-screen::-webkit-scrollbar-thumb:hover {
        background: var(--hover-color);
      }
      .intro-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        margin-bottom: 1rem;
      }
      #intro-screen .intro-header h1 {
        text-align: center;
        font-size: 3.5rem;
        margin-bottom: 1.5rem;
        letter-spacing: 3px;
        text-transform: uppercase;
        text-shadow: 0 2px 20px rgba(255, 255, 255, 0.6);
        color: var(--text-color);
      }
      .intro-content {
        background-color: rgba(12, 22, 133, 0.6);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: 2.5rem 3rem;
        border-radius: 20px;
        box-shadow: 0 8px 40px rgba(36, 54, 255, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.15);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        max-width: 550px;
        width: 90%;
        max-height: calc(100vh - 150px);
      }
      #home-btn {
        background-color: var(--secondary-color);
        color: white;
        font-size: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        width: auto;
        align-self: center;
      }
      #home-btn:hover {
        background-color: var(--highlight-color);
        transform: scale(1.05);
      }
      #team-setup-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        padding-right: 10px;
        padding-left: 5px;
      }
      #team-setup-container::-webkit-scrollbar {
        width: 6px;
      }
      #team-setup-container::-webkit-scrollbar-track {
        background: rgba(0, 0, 30, 0.3);
        border-radius: 3px;
      }
      #team-setup-container::-webkit-scrollbar-thumb {
        background: var(--highlight-color);
        border-radius: 3px;
      }
      #team-setup-container::-webkit-scrollbar-thumb:hover {
        background: var(--hover-color);
      }
      .team-input-row {
        display: flex;
        gap: 0.8rem;
        align-items: center;
        width: 100%;
        transition: background-color 0.3s ease;
        border-radius: 8px;
        background: rgba(10, 27, 170, 0.2);
        padding: 8px 12px;
        border: 1px solid transparent;
      }
      .team-input-row:hover {
        background-color: rgba(10, 27, 170, 0.4);
      }
      .team-name-input {
        flex: 1;
        padding: 0.9rem 1.1rem;
        border-radius: 6px;
        border: 1px solid var(--secondary-color);
        background-color: rgba(6, 13, 93, 0.7);
        color: var(--text-color);
        font-size: 1.1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }
      .team-name-input:focus,
      .team-name-input:focus-visible {
        outline: none;
        border-color: var(--highlight-color);
        box-shadow: 0 0 8px rgba(36, 54, 255, 0.5);
      }
      .remove-team-btn {
        background-color: var(--wrong-color);
        color: white;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease, transform 0.2s ease;
        flex-shrink: 0;
        border: none;
        cursor: pointer;
        padding: 0;
      }
      .remove-team-btn:hover {
        background-color: #c82333;
        transform: scale(1.1);
      }
      .remove-team-btn:active {
        transform: scale(0.95);
      }
      #add-team-btn {
        background-color: var(--secondary-color);
        color: white;
        padding: 0.9rem 1.5rem;
        width: 100%;
        border-radius: 8px;
        font-size: 1.1rem;
        transition: background-color 0.2s ease, transform 0.2s ease;
        border: none;
        font-weight: bold;
      }
      #add-team-btn:hover {
        background-color: var(--highlight-color);
        transform: scale(1.03);
      }
      .start-btn {
        background: linear-gradient(45deg, var(--gold-start), var(--gold-end));
        color: var(--gold-text);
        padding: 1rem 3.5rem;
        font-size: 1.6rem;
        border-radius: 50px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 20px var(--gold-shadow);
        border: none;
        font-weight: bold;
        letter-spacing: 1px;
        margin-top: 1rem;
        text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.2);
      }
      .start-btn:hover {
        background: linear-gradient(
          45deg,
          var(--gold-hover-start),
          var(--gold-hover-end)
        );
        box-shadow: 0 8px 30px var(--gold-shadow);
        transform: scale(1.05);
      }
      .start-btn:active {
        transform: scale(0.98);
      }

      /* === Game Board === */
      #game-board {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .header {
        display: flex;
        align-items: center;
        padding: 0.8rem 1.5rem;
        background-color: var(--primary-color);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        gap: 32rem;
      }
      .header h1 {
        margin: 0;
        font-size: 2rem;
        text-align: left;
        text-shadow: 0 0 8px rgba(255, 255, 255, 0.7),
          0 0 15px rgba(255, 255, 255, 0.5);
        font-weight: bold;
        flex-shrink: 0;
        margin-right: 1rem;
      }
      #current-turn-display {
        background-color: var(--card-color);
        border-radius: 30px;
        padding: 0.6rem 2rem;
        font-size: 1.2rem;
        border: 2px solid var(--highlight-color);
        box-shadow: 0 0 10px rgba(36, 54, 255, 0.4);
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        white-space: nowrap;
        flex-shrink: 0;
      }
      #current-team-name {
        font-weight: bold;
        color: #ffcc00;
      }
      .header-buttons {
        display: flex;
        gap: 0.8rem;
        align-items: center;
        margin: 0;
        flex-shrink: 0;
        margin-left: 1rem;
      }
      .action-btn {
        background-color: var(--highlight-color);
        color: white;
        padding: 0.7rem 1rem;
        font-size: 1rem;
      }
      .action-btn:hover {
        background-color: var(--hover-color);
        transform: translateY(-2px);
      }
      .leaderboard-btn-style {
        background: linear-gradient(45deg, var(--gold-start), var(--gold-end));
        color: var(--gold-text);
        padding: 0.8rem 1.2rem;
        font-size: 1.05rem;
        border-radius: 8px;
        font-weight: bold;
        text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.2);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      }
      .leaderboard-btn-style:hover {
        background: linear-gradient(
          45deg,
          var(--gold-hover-start),
          var(--gold-hover-end)
        );
        box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4);
        transform: translateY(-2px);
      }
      .leaderboard-btn-style i {
        color: var(--gold-text);
        opacity: 0.8;
      }
      .board {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: var(--board-grid-gap);
        gap: var(--board-grid-gap);
        overflow: hidden;
        width: 100%;
      }
      .categories {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: var(--board-grid-gap);
        height: 70px;
        width: 100%;
      }
      .category {
        background-color: var(--secondary-color);
        color: var(--text-color);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        text-align: center;
        font-weight: bold;
        font-size: 1.2rem;
        border-radius: 5px;
        text-transform: uppercase;
        height: 100%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        line-height: 1.2;
      }
      .questions-grid {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        grid-template-rows: repeat(5, 1fr);
        gap: var(--board-grid-gap);
        min-height: 0;
        width: 100%;
      }
      .question-cell {
        background-color: var(--card-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(1.5rem, 5vh, 2.2rem);
        font-weight: bold;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }
      .question-cell::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0) 50%
        );
        z-index: 1;
        pointer-events: none;
      }
      .question-cell span {
        position: relative;
        z-index: 2;
      }
      .question-cell:hover {
        transform: scale(1.02) translateY(-3px);
        background-color: var(--hover-color);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
      }
      .question-cell.answered {
        background-color: rgba(10, 20, 80, 0.5);
        color: rgba(255, 255, 255, 0.4);
        cursor: not-allowed;
        transform: none;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
      }
      .question-cell.answered:hover {
        background-color: rgba(10, 20, 80, 0.5);
        transform: none;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
      }

      /* === Modifiche Griglia Gioco per Numero Colonne === */
      #game-board.category-count-4 .categories,
      #game-board.category-count-4 .questions-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      #game-board.category-count-4 .category:nth-child(n + 5),
      #game-board.category-count-4 .question-cell[data-category="4"] {
        display: none;
      }
      #game-board.category-count-3 .categories,
      #game-board.category-count-3 .questions-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      #game-board.category-count-3 .category:nth-child(n + 4),
      #game-board.category-count-3 .question-cell[data-category="3"],
      #game-board.category-count-3 .question-cell[data-category="4"] {
        display: none;
      }
      #game-board.category-count-2 .categories,
      #game-board.category-count-2 .questions-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      #game-board.category-count-2 .category:nth-child(n + 3),
      #game-board.category-count-2 .question-cell[data-category="2"],
      #game-board.category-count-2 .question-cell[data-category="3"],
      #game-board.category-count-2 .question-cell[data-category="4"] {
        display: none;
      }
      #game-board.category-count-1 .categories,
      #game-board.category-count-1 .questions-grid {
        grid-template-columns: repeat(1, 1fr);
      }
      #game-board.category-count-1 .category:nth-child(n + 2),
      #game-board.category-count-1 .question-cell[data-category="1"],
      #game-board.category-count-1 .question-cell[data-category="2"],
      #game-board.category-count-1 .question-cell[data-category="3"],
      #game-board.category-count-1 .question-cell[data-category="4"] {
        display: none;
      }

      /* === Question Screen === */
      #question-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 20, 0.9);
        z-index: 100;
        padding: 1rem;
      }
      .question-content {
        background-color: var(--card-color);
        width: 90%;
        max-width: 800px;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 0 50px rgba(36, 54, 255, 0.5);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.3rem;
        color: rgba(255, 255, 255, 0.8);
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }
      #question-category {
        font-weight: bold;
        text-transform: uppercase;
        color: var(--text-color);
      }
      #question-value {
        font-weight: bold;
        color: gold;
        background-color: rgba(0, 0, 0, 0.2);
        padding: 0.3rem 0.8rem;
        border-radius: 5px;
      }
      #close-question {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.5rem;
        padding: 5px;
        line-height: 1;
      }
      #close-question:hover {
        color: var(--text-color);
        transform: scale(1.1);
        background: transparent;
      }
      #current-team-indicator {
        background-color: rgba(0, 0, 50, 0.5);
        padding: 0.8rem 1.2rem;
        text-align: center;
        border-radius: 5px;
        font-size: 1.2rem;
        margin-top: -0.5rem;
        border: 1px solid var(--secondary-color);
      }
      #playing-team-name {
        font-weight: bold;
        color: #ffcc00;
      }
      .question-text {
        font-size: clamp(1.5rem, 4vw, 2rem);
        text-align: center;
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1.4;
        padding: 1rem 0;
      }
      .answer-text {
        font-size: clamp(1.3rem, 3.5vw, 1.8rem);
        text-align: center;
        color: #ffdd44;
        font-weight: bold;
        background-color: rgba(0, 0, 50, 0.6);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px dashed var(--highlight-color);
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .button-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
      }
      #show-answer {
        width: 60%;
        padding: 0.8rem 1.5rem;
      }
      #points-control {
        width: 100%;
        padding: 1rem;
        background-color: rgba(0, 0, 50, 0.3);
        border-radius: 8px;
      }
      .score-decision {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap;
      }
      .correct-btn,
      .wrong-btn {
        padding: 1rem 2rem;
        font-size: 1.2rem;
        border-radius: 8px;
        color: white;
        flex-grow: 1;
        max-width: 250px;
      }
      .correct-btn:hover,
      .wrong-btn:hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
      }
      .correct-btn {
        background-color: var(--correct-color);
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
      }
      .wrong-btn {
        background-color: var(--wrong-color);
        box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
      }
      #back-to-board {
        margin-top: 0.5rem;
        width: 60%;
        padding: 0.8rem 1.5rem;
        background-color: var(--neutral-color);
      }
      #back-to-board:hover {
        background-color: #5a6268;
        transform: translateY(-2px);
      }

      /* === Game Over Screen === */
      #game-over-screen {
        background-color: var(--primary-color);
        background-image: linear-gradient(
            180deg,
            rgba(6, 13, 93, 0.95) 0%,
            rgba(10, 27, 170, 0.9) 50%,
            rgba(36, 54, 255, 0.8) 100%
          ),
          radial-gradient(
            circle at top left,
            var(--highlight-color),
            transparent 60%
          ),
          radial-gradient(
            circle at bottom right,
            var(--secondary-color),
            transparent 50%
          );
        padding: 3rem 1rem;
        justify-content: center;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 200;
      }
      #game-over-screen h1 {
        font-size: 4rem;
        color: gold;
        text-shadow: 0 0 8px rgba(0, 0, 0, 0.5), 0 0 15px gold, 0 0 25px gold;
        margin-bottom: 2rem;
      }
      .final-scores {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1.5rem;
        margin: 0 auto 2.5rem auto;
        width: 100%;
        max-width: 1000px;
        padding: 1rem 0;
      }
      .final-team {
        background: linear-gradient(
          145deg,
          var(--card-color),
          var(--secondary-color)
        );
        padding: 1.5rem 2rem;
        border-radius: 12px;
        text-align: center;
        min-width: 200px;
        width: calc(33% - 2rem);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.1),
          0 8px 15px rgba(0, 0, 0, 0.4);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .final-team:hover {
        box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.1),
          0 12px 25px rgba(0, 0, 0, 0.5);
        transform: translateY(-5px);
      }
      .final-team.winner {
        background: linear-gradient(145deg, #fff08d, var(--gold-end));
        color: var(--gold-text);
        transform: scale(1.08) translateY(-5px);
        box-shadow: 0 0 20px var(--gold-shadow), 0 0 40px var(--gold-shadow),
          inset 0 1px 2px rgba(255, 255, 255, 0.5);
        border: 1px solid white;
        position: relative;
        z-index: 10;
      }
      .final-team.winner::before {
        content: "\f521";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 1.8rem;
        color: gold;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      }
      .final-team-name {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.8rem;
        word-break: break-word;
      }
      .final-team.winner .final-team-name {
        color: #4d2c0c;
      }
      .final-team-score {
        font-size: 2.5rem;
        font-weight: bold;
      }
      .final-team-score.negative-score {
        color: var(--wrong-color) !important;
      }
      .final-team.winner .final-team-score {
        color: #6b4f00;
      }
      .game-over-buttons {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 2rem;
        width: 100%;
        flex-wrap: wrap;
      }
      .game-over-buttons > button,
      .game-over-buttons > .button-link {
        padding: 0.7rem 1.6rem;
        font-size: 1.1rem;
        min-width: 180px;
        flex-grow: 0;
        flex-basis: auto;
      }
      #rematch-btn {
        background-color: var(--secondary-color);
        color: white;
      }
      #rematch-btn:hover {
        background-color: var(--highlight-color);
        transform: scale(1.05);
      }
      #new-game.start-btn {
        /* Eredita da .start-btn ma usa dimensioni comuni */
      }

      /* === Stili Popup Generali === */
      .popup-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 20, 0.9);
        z-index: 120;
        padding: 1rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .popup-overlay:not(.hidden) {
        opacity: 1;
        visibility: visible;
      }
      .popup-content {
        background-color: var(--card-color);
        width: 90%;
        max-width: 600px;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(36, 54, 255, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
      }
      .popup-content.large {
        max-width: 700px;
        max-height: 90vh;
      }
      .popup-content h2 {
        color: gold;
        margin-bottom: 0;
        font-size: 1.8rem;
      }
      .popup-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
        width: 100%;
        margin-top: 1rem;
      }
      .popup-btn {
        padding: 0.8rem 1.5rem;
        font-size: 1.1rem;
        border-radius: 8px;
        flex-grow: 1;
        min-width: 120px;
      }
      .popup-btn i {
        margin-right: 0.5rem;
      }
      .choice-btn {
        background-color: var(--highlight-color);
        color: white;
        flex-basis: 40%;
      }
      .choice-btn:hover {
        background-color: var(--hover-color);
        transform: translateY(-2px);
      }
      .confirm-btn {
        background-color: var(--correct-color);
        color: white;
      }
      .confirm-btn:hover:not(:disabled) {
        background-color: #218838;
        transform: translateY(-2px);
      }
      .confirm-btn:disabled {
        background-color: var(--neutral-color);
        cursor: not-allowed;
        opacity: 0.6;
      }
      .cancel-btn {
        background-color: var(--wrong-color);
        color: white;
      }
      .cancel-btn:hover {
        background-color: #c82333;
        transform: translateY(-2px);
      }

      /* === Stili Selezione Manuale Categorie === */
      .category-popup p {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.8);
      }
      #category-selected-count {
        font-weight: bold;
        color: gold;
      }
      .category-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.8rem;
        width: 100%;
        max-height: 45vh;
        overflow-y: auto;
        padding: 1rem;
        background-color: rgba(0, 0, 30, 0.3);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .category-list::-webkit-scrollbar {
        width: 8px;
      }
      .category-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 30, 0.5);
        border-radius: 4px;
      }
      .category-list::-webkit-scrollbar-thumb {
        background: var(--highlight-color);
        border-radius: 4px;
      }
      .category-list::-webkit-scrollbar-thumb:hover {
        background: var(--hover-color);
      }
      .category-item {
        padding: 0.8rem 1rem;
        background-color: var(--secondary-color);
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.2s ease,
          border-color 0.2s ease;
        text-align: center;
        border: 2px solid transparent;
        font-size: 1rem;
        color: var(--text-color);
        user-select: none;
      }
      .category-item:hover {
        background-color: var(--highlight-color);
        transform: scale(1.03);
      }
      .category-item.selected {
        background-color: var(--card-color);
        border-color: gold;
        font-weight: bold;
        color: gold;
      }
      .category-item.disabled:not(.selected) {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: var(--neutral-color);
        border-color: transparent;
      }
      .category-item.disabled:hover:not(.selected) {
        transform: none;
        background-color: var(--neutral-color);
      }

      /* === Responsive Design === */
      @media (max-width: 900px) {
        .header h1 {
          font-size: 1.8rem;
          text-shadow: 0 0 6px rgba(255, 255, 255, 0.6),
            0 0 10px rgba(255, 255, 255, 0.4);
        }
        #current-turn-display {
          font-size: 1.1rem;
          padding: 0.5rem 1.5rem;
        }
        .category {
          font-size: 1.1rem;
        }
        .question-cell {
          font-size: clamp(1.5rem, 4vh, 1.8rem);
        }
        .header {
          padding: 0.8rem 1rem;
        }
        .action-btn,
        .leaderboard-btn-style {
          padding: 0.6rem 0.8rem;
          font-size: 0.9rem;
        }
        .leaderboard-btn-style {
          padding: 0.7rem 1rem;
        }
      }
      @media (max-width: 768px) {
        /* Header wrap & Game Over*/
        .header {
          flex-wrap: wrap;
          justify-content: center;
          padding: 0.8rem 1rem;
          gap: 0.5rem;
        }
        .header h1 {
          width: 100%;
          text-align: center;
          margin-bottom: 0.5rem;
          order: 1;
          margin-right: 0;
        }
        #current-turn-display {
          order: 2;
          margin: 0 auto 0.5rem auto;
          width: auto;
          min-width: 70%;
        }
        .header-buttons {
          order: 3;
          width: 100%;
          justify-content: center;
          margin: 0;
          gap: 0.8rem;
        }
        .category {
          font-size: 1rem;
        }
        .question-cell {
          font-size: clamp(1.3rem, 4vh, 1.5rem);
        }
        .question-text {
          font-size: 1.4rem;
          min-height: 120px;
        }
        .answer-text {
          font-size: 1.2rem;
        }
        .final-team {
          width: calc(50% - 1rem);
          min-width: 160px;
        }
        .game-over-buttons {
          gap: 1rem;
        }
        .game-over-buttons > button,
        .game-over-buttons > .button-link {
          min-width: 160px;
          width: 70%;
          max-width: 280px;
          font-size: 1rem;
          padding: 0.7rem 1.2rem;
        }
        .final-team.winner::before {
          font-size: 1.6rem;
          top: -12px;
        }
        .final-team-name {
          font-size: 1.3rem;
        }
        .final-team-score {
          font-size: 2.2rem;
        }
        .intro-content {
          padding: 2rem 1.5rem;
        }
        .popup-content {
          width: 95%;
          padding: 1.5rem;
        }
        .category-list {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
      }
      @media (max-width: 600px) {
        /* 3 Colonne gioco & Game Over*/
        .categories {
          height: auto;
          grid-template-columns: repeat(3, 1fr);
          height: 60px;
        }
        .category {
          font-size: 0.8rem;
          padding: 0.5rem 0.3rem;
          height: 100%;
        }
        .questions-grid {
          grid-template-columns: repeat(3, 1fr);
        }
        #game-board.category-count-4 .categories,
        #game-board.category-count-4 .questions-grid,
        #game-board.category-count-5 .categories,
        #game-board.category-count-5 .questions-grid {
          grid-template-columns: repeat(3, 1fr);
        }
        .category:nth-child(n + 4),
        .question-cell[data-category="3"],
        .question-cell[data-category="4"],
        #game-board.category-count-4 .category:nth-child(n + 4),
        #game-board.category-count-4 .question-cell[data-category="3"],
        #game-board.category-count-5 .category:nth-child(n + 4),
        #game-board.category-count-5 .question-cell[data-category="3"],
        #game-board.category-count-5 .question-cell[data-category="4"] {
          display: none;
        }
        #game-board.category-count-2 .categories,
        #game-board.category-count-2 .questions-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        #game-board.category-count-2 .category:nth-child(n + 3),
        #game-board.category-count-2 .question-cell[data-category="2"] {
          display: none;
        }
        #game-board.category-count-1 .categories,
        #game-board.category-count-1 .questions-grid {
          grid-template-columns: repeat(1, 1fr);
        }
        #game-board.category-count-1 .category:nth-child(n + 2),
        #game-board.category-count-1 .question-cell[data-category="1"] {
          display: none;
        }
        .question-cell {
          font-size: clamp(1.1rem, 3.5vh, 1.3rem);
        }
        .question-text {
          font-size: 1.2rem;
          min-height: 80px;
        }
        .answer-text {
          font-size: 1.1rem;
          padding: 1rem;
        }
        .correct-btn,
        .wrong-btn {
          font-size: 0.9rem;
          padding: 0.7rem 1rem;
        }
        .score-decision {
          gap: 1rem;
        }
        .intro-content {
          width: 95%;
          padding: 1.5rem 1rem;
          max-height: calc(100vh - 120px);
        }
        #intro-screen .intro-header h1 {
          font-size: 2.5rem;
        }
        .start-btn {
          font-size: 1.3rem;
          padding: 0.8rem 2.5rem;
        }
        #show-answer,
        #back-to-board {
          width: 80%;
        }
        .final-team {
          width: calc(100% - 1rem);
          min-width: unset;
        } /* 1 colonna G.O. */
        .final-team-name {
          font-size: 1.1rem;
        }
        .final-team-score {
          font-size: 1.8rem;
        }
        .leaderboard-content {
          width: 95%;
          padding: 1.5rem 1rem;
        }
        .leaderboard-title {
          font-size: 1.5rem;
        }
        .leaderboard-team-name {
          font-size: 1rem;
        }
        .leaderboard-team-score {
          font-size: 1.2rem;
        }
        .header h1 {
          font-size: 1.5rem;
          text-shadow: 0 0 5px rgba(255, 255, 255, 0.6);
        }
        #current-turn-display {
          font-size: 1rem;
          padding: 0.4rem 1rem;
        }
        .action-btn,
        .leaderboard-btn-style {
          font-size: 0.8rem;
          padding: 0.5rem 0.8rem;
          gap: 0.3rem;
        }
        .leaderboard-btn-style i {
          display: none;
        }
        .board {
          padding: var(--board-grid-gap);
        }
        .categories {
          height: 50px;
        }
        .popup-btn {
          font-size: 1rem;
          padding: 0.7rem 1rem;
        }
        .category-list {
          grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        }
        .game-over-buttons > button,
        .game-over-buttons > .button-link {
          width: 85%;
        }
      }

      /* === End Game Popup === */
      #end-game-popup {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 20, 0.9);
        z-index: 150;
        padding: 1rem;
      }
      #end-game-popup .question-content {
        text-align: center;
      }
      #end-game-popup h2 {
        color: gold;
        margin-bottom: 1rem;
      }
      /* === Winner Animation === */
      @keyframes winner-glow {
        0% {
          transform: scale(1.08) translateY(-5px);
          box-shadow: 0 0 20px var(--gold-shadow), 0 0 40px var(--gold-shadow),
            inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        50% {
          transform: scale(1.12) translateY(-5px);
          box-shadow: 0 0 30px var(--gold-shadow), 0 0 60px #ffe033,
            inset 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        100% {
          transform: scale(1.08) translateY(-5px);
          box-shadow: 0 0 20px var(--gold-shadow), 0 0 40px var(--gold-shadow),
            inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }
      }
      .winner-animation {
        animation: winner-glow 1.5s ease-in-out infinite;
      }
      /* === Donation Notch === */
      .donation-notch {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(10, 20, 80, 0.9);
        padding: 0.8rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.6);
        z-index: 90;
        transform: translateY(100%);
        border-top: 1px solid var(--secondary-color);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .donation-notch.visible,
      .donation-notch:hover {
        transform: translateY(0);
      }
      .donation-handle {
        position: absolute;
        top: -28px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--secondary-color);
        padding: 6px 25px;
        border-radius: 10px 10px 0 0;
        cursor: pointer;
        box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.4);
        color: gold;
        font-weight: bold;
        font-size: 0.9rem;
        white-space: nowrap;
      }
      .donation-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 0 1rem;
        gap: 1rem;
      }
      .donation-text {
        flex: 1;
        color: white;
        margin-right: 1rem;
        font-size: 0.95rem;
      }
      .donation-text h3 {
        color: gold;
        margin-bottom: 0.3rem;
        font-size: 1.1rem;
      }
      .donation-buttons {
        display: flex;
        gap: 0.8rem;
        flex-shrink: 0;
      }
      .donate-btn {
        background-color: var(--highlight-color);
        color: white;
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        border-radius: 5px;
      }
      .donate-btn:hover {
        background-color: var(--hover-color);
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      }
      .donate-btn.paypal {
        background-color: #0079c1;
      }
      .donate-btn.paypal:hover {
        background-color: #005ea6;
      }
      @media (max-width: 768px) {
        .donation-content {
          flex-direction: column;
          gap: 1rem;
          padding: 0.5rem;
        }
        .donation-text {
          margin-right: 0;
          text-align: center;
          font-size: 0.9rem;
        }
        .donation-text h3 {
          font-size: 1rem;
        }
        .donation-buttons {
          justify-content: center;
          width: 100%;
        }
      }
      /* === Stile Punteggio Negativo === */
      .negative-score {
        color: var(--wrong-color) !important;
        font-weight: bold;
      }
      /* === Popup Classifica === */
      /* #leaderboard-btn { background-color: var(--secondary-color); color: white; } Rimosso, usa .leaderboard-btn-style */
      /* #leaderboard-btn:hover { background-color: var(--highlight-color); } */
      #leaderboard-popup {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 20, 0.9);
        z-index: 110;
        padding: 1rem;
      }
      .leaderboard-content {
        background-color: var(--card-color);
        width: 90%;
        max-width: 600px;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 0 50px rgba(36, 54, 255, 0.5);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        max-height: 90vh;
      }
      .leaderboard-title {
        text-align: center;
        font-size: 2rem;
        margin-bottom: 0;
        color: gold;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 215, 0, 0.3);
      }
      .leaderboard-teams {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        overflow-y: auto;
        padding-right: 10px;
      }
      .leaderboard-teams::-webkit-scrollbar {
        width: 6px;
      }
      .leaderboard-teams::-webkit-scrollbar-track {
        background: rgba(0, 0, 30, 0.3);
        border-radius: 3px;
      }
      .leaderboard-teams::-webkit-scrollbar-thumb {
        background: var(--highlight-color);
        border-radius: 3px;
      }
      .leaderboard-teams::-webkit-scrollbar-thumb:hover {
        background: var(--hover-color);
      }
      .leaderboard-team {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: rgba(0, 0, 50, 0.5);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        border-left: 5px solid transparent;
        transition: background-color 0.2s ease;
      }
      .leaderboard-team:hover {
        background-color: rgba(0, 0, 50, 0.7);
      }
      .leaderboard-team:nth-child(1) {
        background-color: rgba(255, 215, 0, 0.2);
        border-left-color: gold;
      }
      .leaderboard-team:nth-child(2) {
        background-color: rgba(192, 192, 192, 0.2);
        border-left-color: silver;
      }
      .leaderboard-team:nth-child(3) {
        background-color: rgba(205, 127, 50, 0.2);
        border-left-color: #cd7f32;
      }
      .leaderboard-team-name {
        font-size: 1.2rem;
        font-weight: bold;
        flex-grow: 1;
        margin-right: 1rem;
      }
      .leaderboard-team-score {
        font-size: 1.5rem;
        font-weight: bold;
        flex-shrink: 0;
      }
      .close-leaderboard-btn {
        align-self: center;
        margin-top: 1rem;
        width: 50%;
        min-width: 150px;
        background-color: var(--neutral-color);
      }
      .close-leaderboard-btn:hover {
        background-color: #5a6268;
        transform: translateY(-2px);
      }
      @media (max-width: 600px) {
        .leaderboard-content {
          width: 95%;
          padding: 1.5rem 1rem;
        }
        .leaderboard-title {
          font-size: 1.5rem;
        }
        .leaderboard-team-name {
          font-size: 1rem;
        }
        .leaderboard-team-score {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <div id="intro-screen" class="active">
        <div class="intro-header"><h1>SAPIENTIX!</h1></div>
        <div class="intro-content">
          <a
            id="home-btn"
            href="index.html"
            class="button-link"
            title="Torna alla Home Principale"
          >
            <i class="fas fa-home"></i> Home
          </a>
          <div id="team-setup-container"></div>
          <button id="add-team-btn">
            <i class="fas fa-plus"></i> Aggiungi Team
          </button>
          <button id="start-game" class="start-btn">Start</button>
        </div>
      </div>
      <div id="game-board" class="hidden">
        <div class="header">
          <h1>SAPIENTIX!</h1>
          <div id="current-turn-display">
            <span id="current-team-name">Team 1</span>: è il tuo turno!
          </div>
          <div class="header-buttons">
            <button
              id="back-to-intro-btn"
              class="action-btn"
              title="Torna alla selezione Team"
            >
              <i class="fas fa-undo"></i>
            </button>
            <button
              id="fullscreen-btn"
              class="action-btn"
              title="Schermo Intero (F)"
            >
              <i class="fas fa-expand"></i>
            </button>
          </div>
        </div>
        <div class="board">
          <div class="categories">
            <div class="category">Cat 1</div>
            <div class="category">Cat 2</div>
            <div class="category">Cat 3</div>
            <div class="category">Cat 4</div>
            <div class="category">Cat 5</div>
          </div>
          <div class="questions-grid">
            <div class="question-cell" data-category="0" data-value="100">
              <span>100</span>
            </div>
            <div class="question-cell" data-category="1" data-value="100">
              <span>100</span>
            </div>
            <div class="question-cell" data-category="2" data-value="100">
              <span>100</span>
            </div>
            <div class="question-cell" data-category="3" data-value="100">
              <span>100</span>
            </div>
            <div class="question-cell" data-category="4" data-value="100">
              <span>100</span>
            </div>
            <div class="question-cell" data-category="0" data-value="200">
              <span>200</span>
            </div>
            <div class="question-cell" data-category="1" data-value="200">
              <span>200</span>
            </div>
            <div class="question-cell" data-category="2" data-value="200">
              <span>200</span>
            </div>
            <div class="question-cell" data-category="3" data-value="200">
              <span>200</span>
            </div>
            <div class="question-cell" data-category="4" data-value="200">
              <span>200</span>
            </div>
            <div class="question-cell" data-category="0" data-value="300">
              <span>300</span>
            </div>
            <div class="question-cell" data-category="1" data-value="300">
              <span>300</span>
            </div>
            <div class="question-cell" data-category="2" data-value="300">
              <span>300</span>
            </div>
            <div class="question-cell" data-category="3" data-value="300">
              <span>300</span>
            </div>
            <div class="question-cell" data-category="4" data-value="300">
              <span>300</span>
            </div>
            <div class="question-cell" data-category="0" data-value="400">
              <span>400</span>
            </div>
            <div class="question-cell" data-category="1" data-value="400">
              <span>400</span>
            </div>
            <div class="question-cell" data-category="2" data-value="400">
              <span>400</span>
            </div>
            <div class="question-cell" data-category="3" data-value="400">
              <span>400</span>
            </div>
            <div class="question-cell" data-category="4" data-value="400">
              <span>400</span>
            </div>
            <div class="question-cell" data-category="0" data-value="500">
              <span>500</span>
            </div>
            <div class="question-cell" data-category="1" data-value="500">
              <span>500</span>
            </div>
            <div class="question-cell" data-category="2" data-value="500">
              <span>500</span>
            </div>
            <div class="question-cell" data-category="3" data-value="500">
              <span>500</span>
            </div>
            <div class="question-cell" data-category="4" data-value="500">
              <span>500</span>
            </div>
          </div>
        </div>
      </div>
      <div id="question-screen" class="hidden">
        <div class="question-content">
          <div class="question-header">
            <span id="question-category"></span>
            <span id="question-value"></span>
            <button id="close-question" title="Chiudi Domanda (Esc)">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="current-team-indicator">
            Turno di: <span id="playing-team-name"></span>
          </div>
          <div id="question-text" class="question-text"></div>
          <div id="answer-text" class="answer-text hidden"></div>
          <div class="button-container">
            <button id="show-answer" class="action-btn">Mostra Risposta</button>
            <div id="points-control" class="hidden">
              <div class="score-decision">
                <button id="correct-answer" class="correct-btn">
                  <i class="fas fa-check"></i> Corretta
                </button>
                <button id="wrong-answer" class="wrong-btn">
                  <i class="fas fa-times"></i> Errata
                </button>
              </div>
            </div>
            <button id="back-to-board" class="action-btn hidden">
              Torna al Tabellone
            </button>
          </div>
        </div>
      </div>
      <div id="game-over-screen" class="hidden">
        <h1>Game Over!</h1>
        <div id="final-scores" class="final-scores"></div>
        <div class="game-over-buttons">
          <button id="rematch-btn" class="popup-btn action-btn">
            <i class="fas fa-redo"></i> Rigioca con stessi Team
          </button>
          <button id="new-game" class="start-btn">
            <i class="fas fa-star"></i> Nuovo Gioco
          </button>
        </div>
      </div>
      <template id="team-input-template">
        <div class="team-input-row">
          <input type="text" class="team-name-input" placeholder="Nome Team" />
          <button class="remove-team-btn" title="Rimuovi Team">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </template>
      <div id="category-choice-popup" class="popup-overlay hidden">
        <div class="popup-content category-popup">
          <h2>Come vuoi scegliere le categorie?</h2>
          <div class="popup-buttons">
            <button id="select-random-categories" class="popup-btn choice-btn">
              <i class="fas fa-random"></i> Casuale
            </button>
            <button id="select-manual-categories" class="popup-btn choice-btn">
              <i class="fas fa-tasks"></i> Manuale
            </button>
          </div>
          <button id="cancel-category-choice" class="popup-btn cancel-btn">
            Annulla
          </button>
        </div>
      </div>
      <div id="manual-category-select-popup" class="popup-overlay hidden">
        <div class="popup-content category-popup large">
          <h2>Seleziona da 1 a 5 categorie</h2>
          <p>Selezionate: <span id="category-selected-count">0</span> / 5</p>
          <div id="manual-category-list" class="category-list"></div>
          <div class="popup-buttons">
            <button
              id="confirm-manual-categories"
              class="popup-btn confirm-btn"
              disabled
            >
              <i class="fas fa-check"></i> Conferma
            </button>
            <button id="cancel-manual-select" class="popup-btn cancel-btn">
              <i class="fas fa-times"></i> Annulla
            </button>
          </div>
        </div>
      </div>
      <div id="end-game-popup" class="hidden">
        <div class="question-content">
          <h2>Fine Partita</h2>
          <p>Tutte le domande sono state completate!</p>
          <button id="show-winner" class="start-btn">Mostra Risultati</button>
        </div>
      </div>
      <div id="leaderboard-popup" class="hidden">
        <div class="leaderboard-content" id="leaderboard-content"></div>
      </div>
      <div class="donation-notch" id="donation-notch">
        <div class="donation-handle">Supportami</div>
        <div class="donation-content">
          <div class="donation-text">
            <h3>Aiutami a migliorare!</h3>
            <p>Il tuo contributo mi aiuterà ad aggiungere giochi e a migliorare quelli esistenti.</p>
          </div>
          <div class="donation-buttons">
            <a
              href="https://paypal.me/weebstorm?country.x=IT&locale.x=it_IT"
              target="_blank"
              rel="noopener noreferrer"
              class="donate-btn paypal button-link"
            >
              <i class="fab fa-paypal"></i> PayPal
            </a>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Incolla qui l'INTERO blocco JavaScript aggiornato dalla risposta precedente
      // (quello con entrambe le funzioni updateCategoryDisplay e updateCurrentTeamDisplay definite)
      document.addEventListener("DOMContentLoaded", () => {
        // === Element Selection (VERIFICA CHE SIANO TUTTE PRESENTI) ===
        const introScreen = document.getElementById("intro-screen");
        const gameBoard = document.getElementById("game-board");
        const questionScreen = document.getElementById("question-screen");
        const gameOverScreen = document.getElementById("game-over-screen"); // <-- DEFINIZIONE VERIFICATA
        const startButton = document.getElementById("start-game");
        const fullscreenBtn = document.getElementById("fullscreen-btn");
        const questionCellElements =
          document.querySelectorAll(".question-cell");
        const showAnswerBtn = document.getElementById("show-answer");
        const backToBoardBtn = document.getElementById("back-to-board");
        const questionCategory = document.getElementById("question-category");
        const questionValue = document.getElementById("question-value");
        const questionText = document.getElementById("question-text");
        const answerText = document.getElementById("answer-text");
        const newGameBtn = document.getElementById("new-game");
        const finalScores = document.getElementById("final-scores");
        const teamSetupContainer = document.getElementById(
          "team-setup-container"
        );
        const addTeamBtn = document.getElementById("add-team-btn");
        const playingTeamName = document.getElementById("playing-team-name");
        const pointsControl = document.getElementById("points-control");
        const correctAnswerBtn = document.getElementById("correct-answer");
        const wrongAnswerBtn = document.getElementById("wrong-answer");
        const categoryElements = document.querySelectorAll(".category");
        const closeQuestionBtn = document.getElementById("close-question");
        const backToIntroBtn = document.getElementById("back-to-intro-btn");
        const endGamePopup = document.getElementById("end-game-popup");
        const showWinnerBtn = document.getElementById("show-winner");
        const leaderboardPopup = document.getElementById("leaderboard-popup");
        const leaderboardContent = document.getElementById(
          "leaderboard-content"
        );
        const donationNotch = document.getElementById("donation-notch");
        const donationHandle = document.querySelector(".donation-handle");
        const categoryChoicePopup = document.getElementById(
          "category-choice-popup"
        );
        const manualCategorySelectPopup = document.getElementById(
          "manual-category-select-popup"
        );
        const selectRandomBtn = document.getElementById(
          "select-random-categories"
        );
        const selectManualBtn = document.getElementById(
          "select-manual-categories"
        );
        const cancelCategoryChoiceBtn = document.getElementById(
          "cancel-category-choice"
        );
        const manualCategoryList = document.getElementById(
          "manual-category-list"
        );
        const categorySelectedCount = document.getElementById(
          "category-selected-count"
        );
        const confirmManualCategoriesBtn = document.getElementById(
          "confirm-manual-categories"
        );
        const cancelManualSelectBtn = document.getElementById(
          "cancel-manual-select"
        );
        const rematchBtn = document.getElementById("rematch-btn"); // Seleziona bottone Rematch

        // === Game State ===
        let teams = [];
        let currentTeamIndex = 0;
        let currentQuestion = null;
        let answeredQuestionsCount = 0;
        let totalQuestions = 25;
        let categories = [];
        let gameData = { allCategories: [], questions: [] };
        let currentGameQuestions = [];
        const MAX_CATEGORIES = 5;

        // === Funzioni Base ===
        async function loadGameData() {
          try {
            const r = await fetch(`dati.json?v=${new Date().getTime()}`);
            if (!r.ok) throw new Error(`E:${r.status}`);
            gameData = await r.json();
            if (
              !gameData ||
              !Array.isArray(gameData.allCategories) ||
              !Array.isArray(gameData.questions)
            ) {
              console.error("Fmt Err", gameData);
              gameData = {
                allCategories: [
                  "Errore 1",
                  "Errore 2",
                  "Errore 3",
                  "Errore 4",
                  "Errore 5",
                ],
                questions: [],
              };
              alert("Errore Dati.");
            } else {
              console.log("Dati OK.");
              gameData.allCategories.sort(); /* Ordinamento Alfabetico */
            }
          } catch (e) {
            console.error("Load Err", e);
            gameData = {
              allCategories: ["LE A", "LE B", "LE C", "LE D", "LE E"],
              questions: [],
            };
            alert("Impossibile caricare.");
          }
        }
        function updateCategoryDisplay(selectedCategories) {
          categoryElements.forEach((element, index) => {
            if (index < selectedCategories.length) {
              element.textContent =
                selectedCategories[index] || `Cat. ${index + 1}`;
            } else {
              element.textContent = "-";
            }
          });
        }
        function updateCurrentTeamDisplay() {
          const d = document.querySelector("#current-turn-display");
          if (!d) {
            console.error("#current-turn-display missing!");
            return;
          }
          if (teams.length > 0 && teams[currentTeamIndex]) {
            d.innerHTML = `<span id="current-team-name">${teams[currentTeamIndex].name}</span>: è il tuo turno!`;
          } else {
            d.innerHTML = `- : -`;
          }
        }
        function initTeamSetup() {
          teamSetupContainer.innerHTML = "";
          for (let i = 0; i < 2; i++) {
            addTeamInput(`Team ${i + 1}`);
          }
          addTeamBtn.removeEventListener("click", handleAddTeamClick);
          addTeamBtn.addEventListener("click", handleAddTeamClick);
        }
        function handleAddTeamClick() {
          addTeamInput();
        }
        function addTeamInput(defaultName = "") {
          const t = document.getElementById("team-input-template");
          const r = t.content.cloneNode(true);
          const i = r.querySelector(".team-name-input");
          const n = teamSetupContainer.children.length + 1;
          if (defaultName) {
            i.value = defaultName;
          } else {
            i.placeholder = `Nome Team ${n}`;
          }
          r.querySelector(".remove-team-btn").addEventListener(
            "click",
            function () {
              const rm = this.closest(".team-input-row");
              rm.style.transition = "opacity .3s, transform .3s";
              rm.style.opacity = "0";
              rm.style.transform = "translateX(-20px)";
              setTimeout(() => {
                rm.remove();
                renumberTeamPlaceholders();
              }, 300);
            }
          );
          teamSetupContainer.appendChild(r);
          teamSetupContainer.scrollTop = teamSetupContainer.scrollHeight;
        }
        function renumberTeamPlaceholders() {
          const i = teamSetupContainer.querySelectorAll(".team-name-input");
          i.forEach((inp, idx) => {
            if (
              !inp.value &&
              (inp.placeholder.startsWith("Team") ||
                inp.placeholder.startsWith("Nome Team"))
            ) {
              inp.placeholder = `Nome Team ${idx + 1}`;
            }
          });
        }

        // === NUOVO Flusso Inizializzazione Gioco ===
        function handleStartGameClick() {
          const teamInputs =
            teamSetupContainer.querySelectorAll(".team-name-input");
          teams = [];
          teamInputs.forEach((input, index) => {
            const teamName =
              input.value.trim() ||
              input.placeholder.trim() ||
              `Team ${index + 1}`;
            let finalName = teamName;
            let count = 2;
            while (teams.some((team) => team.name === finalName)) {
              finalName = `${teamName} (${count++})`;
            }
            teams.push({ name: finalName, score: 0 });
          });
          if (teams.length === 0) {
            alert("Aggiungi almeno un team per iniziare!");
            return;
          }
          introScreen.classList.remove("active");
          introScreen.classList.add("hidden");
          categoryChoicePopup.classList.remove("hidden");
        }
        selectRandomBtn.addEventListener(
          "click",
          startGameWithRandomCategories
        );
        selectManualBtn.addEventListener("click", showManualCategorySelector);
        cancelCategoryChoiceBtn.addEventListener("click", () => {
          categoryChoicePopup.classList.add("hidden");
          introScreen.classList.add("active");
          introScreen.classList.remove("hidden");
        });
        function showManualCategorySelector() {
          categoryChoicePopup.classList.add("hidden");
          populateManualCategoryList();
          manualCategorySelectPopup.classList.remove("hidden");
          updateManualSelectionUI();
        }
        function populateManualCategoryList() {
          manualCategoryList.innerHTML = "";
          if (!gameData || !gameData.allCategories) {
            console.error("Categorie non caricate");
            return;
          }
          gameData.allCategories.forEach((catName) => {
            const div = document.createElement("div");
            div.classList.add("category-item");
            div.textContent = catName;
            div.dataset.categoryName = catName;
            div.setAttribute("role", "button");
            div.setAttribute("tabindex", "0");
            div.addEventListener("click", handleManualCategoryItemToggle);
            div.addEventListener("keydown", (e) => {
              if (e.code === "Enter" || e.code === "Space") {
                handleManualCategoryItemToggle(e);
                e.preventDefault();
              }
            });
            manualCategoryList.appendChild(div);
          });
        }
        function handleManualCategoryItemToggle(event) {
          const targetDiv = event.currentTarget;
          const isCurrentlySelected = targetDiv.classList.contains("selected");
          const selectedCount = manualCategoryList.querySelectorAll(
            ".category-item.selected"
          ).length;
          if (
            targetDiv.classList.contains("disabled") &&
            !isCurrentlySelected
          ) {
            return;
          }
          if (!isCurrentlySelected && selectedCount >= MAX_CATEGORIES) {
            targetDiv.style.transform = "scale(1.01)";
            setTimeout(() => (targetDiv.style.transform = ""), 150);
            console.log("Limite max");
            return;
          }
          targetDiv.classList.toggle("selected");
          updateManualSelectionUI();
        }
        function updateManualSelectionUI() {
          const selectedItems = manualCategoryList.querySelectorAll(
            ".category-item.selected"
          );
          const count = selectedItems.length;
          categorySelectedCount.textContent = count;
          confirmManualCategoriesBtn.disabled =
            count === 0 || count > MAX_CATEGORIES;
          const allItems =
            manualCategoryList.querySelectorAll(".category-item");
          allItems.forEach((item) => {
            const isSelected = item.classList.contains("selected");
            const isDisabled = !isSelected && count >= MAX_CATEGORIES;
            item.classList.toggle("disabled", isDisabled);
            item.setAttribute("tabindex", isDisabled ? "-1" : "0");
          });
        }
        confirmManualCategoriesBtn.addEventListener("click", () => {
          const selectedCategories = [];
          manualCategoryList
            .querySelectorAll(".category-item.selected")
            .forEach((item) => {
              selectedCategories.push(item.dataset.categoryName);
            });
          if (
            selectedCategories.length > 0 &&
            selectedCategories.length <= MAX_CATEGORIES
          ) {
            manualCategorySelectPopup.classList.add("hidden");
            startGameWithSelectedCategories(selectedCategories);
          } else {
            console.warn(
              "Conf Tenta con n cat non valido:",
              selectedCategories.length
            );
          }
        });
        cancelManualSelectBtn.addEventListener("click", () => {
          manualCategorySelectPopup.classList.add("hidden");
          categoryChoicePopup.classList.remove("hidden");
        });

        // === NUOVE Funzioni per Avviare il Gioco ===
        function startGameWithRandomCategories() {
          categoryChoicePopup.classList.add("hidden");
          console.log("Starting random...");
          try {
            console.log("  -> Selecting random...");
            categories = selectRandomCategoriesHelper(MAX_CATEGORIES);
            if (!categories || categories.length === 0)
              throw new Error("No random categories selected.");
            console.log(`  -> Sel: ${categories.join(", ")}`);
            setupAndShowBoard(categories);
          } catch (error) {
            console.error("!!! Err startGameRandom:", error);
            alert(`Error starting random: ${error.message}.`);
            introScreen.classList.add("active");
            introScreen.classList.remove("hidden");
            categoryChoicePopup.classList.add("hidden");
            manualCategorySelectPopup.classList.add("hidden");
          }
        }
        function startGameWithSelectedCategories(selectedCategories) {
          manualCategorySelectPopup.classList.add("hidden");
          console.log("Starting manual:", selectedCategories);
          try {
            if (!selectedCategories || selectedCategories.length === 0)
              throw new Error("No categories passed.");
            categories = selectedCategories;
            setupAndShowBoard(categories);
          } catch (error) {
            console.error("!!! Err startGameManual:", error);
            alert(`Error starting manual: ${error.message}.`);
            introScreen.classList.add("active");
            introScreen.classList.remove("hidden");
            categoryChoicePopup.classList.add("hidden");
            manualCategorySelectPopup.classList.add("hidden");
          }
        }
        function setupAndShowBoard(boardCategories) {
          console.log("Executing setupAndShowBoard:", boardCategories);
          if (!boardCategories || boardCategories.length === 0) {
            console.error("!!! setupAndShowBoard: invalid categories!");
            alert("Internal error: invalid categories.");
            startNewGame();
            return;
          }
          try {
            console.log("  1. Update cat display...");
            updateCategoryDisplay(boardCategories);
            console.log("  2. Update board CSS...");
            gameBoard.className = gameBoard.className
              .replace(/category-count-\d/g, "")
              .trim();
            if (boardCategories.length < MAX_CATEGORIES) {
              gameBoard.classList.add(
                `category-count-${boardCategories.length}`
              );
            }
            console.log(`     Class: ${gameBoard.className}`);
            console.log("  3. Select questions...");
            currentGameQuestions =
              selectRandomQuestionsForBoard(boardCategories);
            console.log(`     -> ${currentGameQuestions.length} selected.`);
            if (
              currentGameQuestions.length === 0 &&
              boardCategories.length > 0
            ) {
              console.warn("     WARN: No questions found!");
            }
            console.log("  4. Set counts...");
            totalQuestions = boardCategories.length * 5;
            answeredQuestionsCount = 0;
            console.log(
              `     -> Total: ${totalQuestions}, Answered: ${answeredQuestionsCount}`
            );
            console.log("  5. Reset cells...");
            resetBoardCells();
            console.log("  6. Set team...");
            currentTeamIndex = 0;
            updateCurrentTeamDisplay();
            console.log("  7. Show Board...");
            if (!gameBoard) throw new Error("#game-board missing!");
            gameBoard.classList.remove("hidden");
            gameBoard.classList.add("active");
            if (!gameOverScreen) throw new Error("#game-over-screen missing!");
            gameOverScreen.classList.add("hidden");
            console.log("  -> Board VISIBLE.");
          } catch (error) {
            console.error("!!! Error INSIDE setupAndShowBoard:", error);
            alert(
              `Critical board setup error:\n${error.message}\nCheck console.`
            );
            introScreen.classList.add("active");
            introScreen.classList.remove("hidden");
            categoryChoicePopup.classList.add("hidden");
            manualCategorySelectPopup.classList.add("hidden");
            if (gameBoard) {
              gameBoard.classList.add("hidden");
              gameBoard.classList.remove("active");
            }
          }
        }

        // === Funzioni Helper ===
        function resetBoardCells() {
          questionCellElements.forEach((cell) => {
            cell.classList.remove("answered");
            cell.removeEventListener("click", handleQuestionClick);
            cell.addEventListener("click", handleQuestionClick);
          });
        }
        function selectRandomCategoriesHelper(count) {
          const a = gameData.allCategories;
          if (!a || a.length === 0) {
            console.error("No cats in gameData!");
            return [];
          }
          const s = [...a].sort(() => 0.5 - Math.random());
          return s.slice(0, Math.min(count, a.length));
        }
        function selectRandomQuestionsForBoard(boardCategories) {
          const sq = [];
          const v = [100, 200, 300, 400, 500];
          if (!boardCategories || boardCategories.length === 0) {
            console.error("selectRQFB no cats!");
            return [];
          }
          /*console.log("    Selecting Qs for:", boardCategories); console.log("    Data:", gameData.questions);*/ boardCategories.forEach(
            (catName, catIdx) => {
              /*console.log(`    -> Cat ${catIdx}: ${catName}`);*/ v.forEach(
                (val) => {
                  /*console.log(`      -> Val: ${val}`);*/ let cq;
                  try {
                    cq = gameData.questions.filter(
                      (q) => q && q.category === catName && q.value === val
                    );
                  } catch (filterError) {
                    console.error(
                      `Filter Error ${catName}/${val}:`,
                      filterError
                    );
                    cq = [];
                  }
                  /*console.log(`        Found ${cq.length}`);*/ let chosenQ;
                  if (cq.length > 0) {
                    const i = Math.floor(Math.random() * cq.length);
                    chosenQ = { ...cq[i] };
                  } else {
                    console.warn(`        No Q "${catName}"/${val}. Fallback.`);
                    chosenQ = {
                      category: catName,
                      value: val,
                      question: `R ${catName}(${val})`,
                      answer: "R",
                    };
                  }
                  chosenQ.categoryIndex = catIdx;
                  sq.push(chosenQ);
                }
              );
            }
          );
          return sq;
        }

        // === Funzioni di Gioco Esistenti ===
        function closeQuestion() {
          questionScreen.classList.add("hidden");
          questionScreen.classList.remove("active");
          answerText.classList.add("hidden");
          pointsControl.classList.add("hidden");
          backToBoardBtn.classList.add("hidden");
          showAnswerBtn.classList.remove("hidden");
        }
        function handleQuestionClick(event) {
          const c = event.currentTarget;
          if (c.classList.contains("answered")) return;
          const ci = parseInt(c.getAttribute("data-category"));
          const v = parseInt(c.getAttribute("data-value"));
          currentQuestion = currentGameQuestions.find(
            (q) => q && q.categoryIndex === ci && q.value === v
          );
          if (!currentQuestion) {
            console.error(`Q Err ${ci}/${v}. Array:`, currentGameQuestions);
            alert("Err Dati Q!");
            return;
          }
          questionCategory.textContent = categories[ci] || "N/D";
          questionValue.textContent = v + " P";
          questionText.textContent = currentQuestion.question || "?";
          answerText.textContent = currentQuestion.answer || "-";
          playingTeamName.textContent = teams[currentTeamIndex]?.name || "N/D";
          answerText.classList.add("hidden");
          pointsControl.classList.add("hidden");
          showAnswerBtn.classList.remove("hidden");
          backToBoardBtn.classList.add("hidden");
          questionScreen.classList.remove("hidden");
          questionScreen.classList.add("active");
        }
        function showAnswer() {
          showAnswerBtn.classList.add("hidden");
          answerText.classList.remove("hidden");
          pointsControl.classList.remove("hidden");
        }
        function handleCorrectAnswer() {
          if (!currentQuestion) return;
          teams[currentTeamIndex].score += currentQuestion.value;
          finalizeQuestion();
        }
        function handleWrongAnswer() {
          if (!currentQuestion) return;
          teams[currentTeamIndex].score -= currentQuestion.value;
          finalizeQuestion();
        }
        function finalizeQuestion() {
          pointsControl.classList.add("hidden");
          backToBoardBtn.classList.remove("hidden");
        }
        function backToBoard() {
          if (!currentQuestion) return;
          const c = document.querySelector(
            `.question-cell[data-category="${currentQuestion.categoryIndex}"][data-value="${currentQuestion.value}"]`
          );
          if (c && !c.classList.contains("answered")) {
            c.classList.add("answered");
            answeredQuestionsCount++;
          }
          questionScreen.classList.add("hidden");
          questionScreen.classList.remove("active");
          currentTeamIndex = (currentTeamIndex + 1) % teams.length;
          updateCurrentTeamDisplay();
          currentQuestion = null;
          console.log(
            `Answered: ${answeredQuestionsCount} / ${totalQuestions}`
          );
          if (answeredQuestionsCount >= totalQuestions) {
            setTimeout(() => {
              endGamePopup.classList.remove("hidden");
              endGamePopup.classList.add("active");
            }, 300);
          }
        }

        // === Funzioni Fine Gioco e Utility ===
        function showGameOverScreen() {
          endGamePopup.classList.add("hidden");
          endGamePopup.classList.remove("active");
          gameBoard.classList.add("hidden");
          gameBoard.classList.remove("active");
          let max = -Infinity;
          teams.forEach((t) => {
            if (t.score > max) max = t.score;
          });
          const w = teams.filter((t) => t.score === max);
          const s = [...teams].sort((a, b) => b.score - a.score);
          finalScores.innerHTML = "";
          s.forEach((t) => {
            const d = document.createElement("div");
            d.className = "final-team";
            if (w.some((win) => win.name === t.name)) d.classList.add("winner");
            const n = document.createElement("div");
            n.className = "final-team-name";
            n.textContent = t.name;
            const sc = document.createElement("div");
            sc.className = "final-team-score";
            sc.textContent = t.score;
            if (t.score < 0) sc.classList.add("negative-score");
            d.appendChild(n);
            d.appendChild(sc);
            finalScores.appendChild(d);
          });
          gameOverScreen.classList.remove("hidden");
          gameOverScreen.classList.add("active");
          setTimeout(() => {
            document
              .querySelectorAll(".final-team.winner")
              .forEach((wd) => wd.classList.add("winner-animation"));
          }, 500);
        }
        function rematchWithSameTeams() {
          console.log(
            "Rematch:",
            teams.map((t) => t.name)
          );
          if (!teams || teams.length === 0) {
            console.error("No teams for rematch.");
            startNewGame();
            return;
          }
          teams.forEach((team) => (team.score = 0));
          gameOverScreen.classList.add("hidden");
          gameOverScreen.classList.remove("active");
          questionScreen.classList.add("hidden");
          questionScreen.classList.remove("active");
          leaderboardPopup.classList.add("hidden");
          manualCategorySelectPopup.classList.add("hidden");
          document
            .querySelectorAll(".final-team.winner")
            .forEach((w) => w.classList.remove("winner-animation"));
          gameBoard.className = gameBoard.className
            .replace(/category-count-\d/g, "")
            .trim();
          currentQuestion = null;
          answeredQuestionsCount = 0;
          categories = [];
          currentGameQuestions = [];
          totalQuestions = 25;
          categoryChoicePopup.classList.remove("hidden");
        }
        function startNewGame() {
          gameOverScreen.classList.add("hidden");
          gameOverScreen.classList.remove("active");
          endGamePopup.classList.add("hidden");
          endGamePopup.classList.remove("active");
          gameBoard.classList.add("hidden");
          gameBoard.classList.remove("active");
          questionScreen.classList.add("hidden");
          questionScreen.classList.remove("active");
          leaderboardPopup.classList.add("hidden");
          categoryChoicePopup.classList.add("hidden");
          manualCategorySelectPopup.classList.add("hidden");
          introScreen.classList.remove("hidden");
          introScreen.classList.add("active");
          currentQuestion = null;
          answeredQuestionsCount = 0;
          currentTeamIndex = 0;
          teams = [];
          categories = [];
          currentGameQuestions = [];
          totalQuestions = 25;
          document
            .querySelectorAll(".final-team.winner")
            .forEach((w) => w.classList.remove("winner-animation"));
          document
            .querySelectorAll(".question-cell, .category")
            .forEach((el) => (el.style.display = ""));
          gameBoard.className = gameBoard.className
            .replace(/category-count-\d/g, "")
            .trim();
          initTeamSetup();
        }
        function toggleFullscreen() {
          if (!document.fullscreenElement) {
            document.documentElement
              .requestFullscreen()
              .catch((e) => console.warn(e));
          } else {
            if (document.exitFullscreen) document.exitFullscreen();
          }
        }
        function updateFullscreenIcon() {
          if (document.fullscreenElement) {
            fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            fullscreenBtn.title = "Esci (F o Esc)";
          } else {
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = "Schermo Intero (F)";
          }
        }
        function showCurrentRanking() {
          if (teams.length === 0) return;
          leaderboardContent.innerHTML = "";
          const tt = document.createElement("div");
          tt.className = "leaderboard-title";
          tt.textContent = "Classifica";
          leaderboardContent.appendChild(tt);
          const tc = document.createElement("div");
          tc.className = "leaderboard-teams";
          const st = [...teams].sort((a, b) => b.score - a.score);
          st.forEach((t, i) => {
            const ti = document.createElement("div");
            ti.className = "leaderboard-team";
            const tn = document.createElement("div");
            tn.className = "leaderboard-team-name";
            tn.textContent = `${i + 1}. ${t.name}`;
            const ts = document.createElement("div");
            ts.className = "leaderboard-team-score";
            ts.textContent = t.score;
            if (t.score < 0) ts.classList.add("negative-score");
            ti.appendChild(tn);
            ti.appendChild(ts);
            tc.appendChild(ti);
          });
          leaderboardContent.appendChild(tc);
          const cb = document.createElement("button");
          cb.className = "action-btn close-leaderboard-btn";
          cb.textContent = "Chiudi";
          cb.addEventListener("click", () =>
            leaderboardPopup.classList.add("hidden")
          );
          leaderboardContent.appendChild(cb);
          leaderboardPopup.classList.remove("hidden");
        }
        function backToIntro() {
          startNewGame();
        }
        function createRankingButton() {
          const eb = document.getElementById("leaderboard-btn");
          if (eb) return;
          const rb = document.createElement("button");
          rb.id = "leaderboard-btn";
          rb.className = "button-like leaderboard-btn-style";
          rb.innerHTML = '<i class="fas fa-trophy"></i> Classifica';
          rb.title = "Mostra Classifica (R)";
          rb.addEventListener("click", showCurrentRanking);
          const hb = document.querySelector(".header-buttons");
          if (hb) {
            const ref = hb.querySelector("#back-to-intro-btn");
            if (ref) hb.insertBefore(rb, ref);
            else hb.insertBefore(rb, hb.firstChild);
          } else console.error(".header-buttons missing");
        }
        function setupDonationNotch() {
          if (donationHandle && donationNotch)
            donationHandle.addEventListener("click", () =>
              donationNotch.classList.toggle("visible")
            );
        }

        // === Event Listeners Essenziali ===
        startButton.addEventListener("click", handleStartGameClick);
        fullscreenBtn.addEventListener("click", toggleFullscreen);
        newGameBtn.addEventListener("click", startNewGame);
        if (rematchBtn) {
          rematchBtn.addEventListener("click", rematchWithSameTeams);
        }
        showWinnerBtn.addEventListener("click", showGameOverScreen);
        backToIntroBtn.addEventListener("click", backToIntro);
        showAnswerBtn.addEventListener("click", showAnswer);
        correctAnswerBtn.addEventListener("click", handleCorrectAnswer);
        wrongAnswerBtn.addEventListener("click", handleWrongAnswer);
        backToBoardBtn.addEventListener("click", backToBoard);
        closeQuestionBtn.addEventListener("click", closeQuestion);
        document.addEventListener("fullscreenchange", updateFullscreenIcon);
        document.addEventListener("keydown", (e) => {
          if (e.target.tagName === "INPUT") return;
          if (e.code === "Escape") {
            if (!manualCategorySelectPopup.classList.contains("hidden")) {
              cancelManualSelectBtn.click();
              e.preventDefault();
            } else if (!categoryChoicePopup.classList.contains("hidden")) {
              cancelCategoryChoiceBtn.click();
              e.preventDefault();
            } else if (!leaderboardPopup.classList.contains("hidden")) {
              leaderboardPopup.classList.add("hidden");
              e.preventDefault();
            } else if (!questionScreen.classList.contains("hidden")) {
              closeQuestion();
              e.preventDefault();
            }
          } else if (
            e.code === "Space" &&
            !questionScreen.classList.contains("hidden") &&
            !showAnswerBtn.classList.contains("hidden")
          ) {
            showAnswer();
            e.preventDefault();
          } else if (
            e.code === "Enter" &&
            !questionScreen.classList.contains("hidden")
          ) {
            if (!showAnswerBtn.classList.contains("hidden")) {
              showAnswer();
              e.preventDefault();
            } else if (!backToBoardBtn.classList.contains("hidden")) {
              backToBoard();
              e.preventDefault();
            }
          } else if (
            !questionScreen.classList.contains("hidden") &&
            !pointsControl.classList.contains("hidden")
          ) {
            if (e.key === "1") {
              handleCorrectAnswer();
              e.preventDefault();
            } else if (e.key === "2") {
              handleWrongAnswer();
              e.preventDefault();
            }
          } else if (e.code === "KeyF") {
            toggleFullscreen();
            e.preventDefault();
          } else if (
            e.code === "KeyR" &&
            !gameBoard.classList.contains("hidden")
          ) {
            if (leaderboardPopup.classList.contains("hidden")) {
              showCurrentRanking();
            } else {
              leaderboardPopup.classList.add("hidden");
            }
            e.preventDefault();
          }
        });

        // === Inizializzazione ===
        async function initialize() {
          await loadGameData();
          initTeamSetup();
          createRankingButton();
          setupDonationNotch();
          updateFullscreenIcon();
        }
        initialize();
      });
    </script>
  </body>
</html>
